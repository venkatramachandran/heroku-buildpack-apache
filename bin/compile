#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

BIN_DIR=$(dirname $0)
BUILD_DIR=$1
CACHE_DIR=$2
LP_DIR=`cd $(dirname $0); cd ..; pwd`

# include .files when moving things around
shopt -s dotglob

cd $BUILD_DIR

sudo apt-get update
sudo apt-get install -qy apache2
sudo a2dissite 000-default
sudo cp /app/conf/apache2.conf /etc/apache2
sudo sed -i 's_Listen 80_Listen 5000_' /etc/apache2/ports.conf
sudo service apache2 stop

cat >>boot.sh <<EOF
set +x
sudo echo '192.168.56.101 stack' >> /etc/hosts
sudo apache2ctl -DNO_DETACH
EOF

chmod +x boot.sh

# clean the cache
rm -rf $CACHE_DIR/*
